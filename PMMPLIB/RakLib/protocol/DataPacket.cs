using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using PMMPLIB.Utils.Linq;

namespace PMMPLIB.RakLib.Protocol
{
    public abstract class DataPacket : Packet
    {
        public abstract byte GetID();

        public int seqNumber { get; set; }

        private List<MessagePart> _MessageParts = new List<MessagePart>();
        public IEnumerable<MessagePart> MessageParts { get { return _MessageParts; } }

        public void AddMessage(MessagePart message)
        {
            if (message == null)
                throw new ArgumentNullException();
            _MessageParts.Add(message);
        }

        public void Encode(System.IO.MemoryStream stream)
        {
            stream.WriteByte(GetID());
            stream.WriteInt24(seqNumber);
            foreach (var message in MessageParts)
                message.Encode(stream);
        }

        public void Decode(System.IO.MemoryStream stream)
        {
            stream.ReadByte();//id
            seqNumber = stream.ReadInt24();
            while (stream.Position < stream.Length)
            {
                var pk = new MessagePart();
                pk.Decode(stream);
                _MessageParts.Add(pk);
            }
        }
    }
}
